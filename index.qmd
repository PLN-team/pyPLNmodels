---
title: "Omega RMSE vs Sigma RMSE"
format:
  html:
      code-fold: false
jupyter: python3
---
Here we compare the RMSE between Pln and ZIPln for $\Omega$ and $\Sigma$. We fit Pln on Pln data, ZIPln on ZIPln data and Pln on ZIPln data.

## Imports


```{python}
from pyPLNmodels import Pln, ZIPln, get_simulation_parameters, sample_zipln
import torch
import seaborn as sns
import matplotlib.pyplot as plt
import numpy as np
```

## Sample parameters

```{python}
n_samples = 1000
parameters = get_simulation_parameters(
    zero_inflation_formula="global", n_samples=n_samples, dim=200
)
parameters._set_gaussian_mean(2)
parameters._set_mean_proba(0.3)

exog = parameters.exog
exog_inflation = parameters.exog_inflation
offsets = parameters.offsets
true_Sigma = parameters.covariance
true_Omega = torch.inverse(true_Sigma)
true_coef = parameters.coef
nb_iter = 500
```
## Sample the Y
We can get the Y simulated from the poisson component when simulating ZIPln data, for ease of comparison
```{python}
endog_zi, endog_pln = sample_zipln(parameters, return_pln=True)

print(
    "percentage of zeros for the zero inflated data",
    torch.mean((endog_zi == 0).float()),
)
print(
    "percentage of zeros for the non inflated data",
    torch.mean((endog_pln == 0).float()),
)
```

## Fitting the models
We fit 3 different models, ZIPln on ZIPln data, Pln on Pln data and Pln on ZIpln data.
```{python}
zi = ZIPln(endog_zi, exog=exog, zero_inflation_formula="global", offsets=offsets)
zi.fit(tol=0, nb_max_iteration=nb_iter)

fairpln = Pln(endog_pln, exog=exog, offsets=offsets)
fairpln.fit(tol=0, nb_max_iteration=nb_iter)

pln = Pln(endog_zi, exog=exog, offsets=offsets)
pln.fit(tol=0, nb_max_iteration=nb_iter)
```
#### Defining some functions to check covariance and coef mse

```{python}
def rmse(t):
    return np.round(torch.sqrt(torch.mean(t**2)), 3)

def check_covariance_coef(model, ax, label):
    Sigma = model.covariance
    Omega = torch.inverse(Sigma)
    coef = model.coef
    mse_Sigma = rmse(Sigma - true_Sigma)
    mse_Omega = rmse(Omega - true_Omega)
    mse_coef = rmse(coef - true_coef)
    sns.heatmap(Omega, ax=ax)
    title = rf"{label} RMSE: $\Sigma$:{mse_Sigma}, $\Omega$:{mse_Omega}, $B$:{mse_coef}"
    ax.set_title(title)
    ax.title.set_size(10)
```
## Plot the correlation matrix $\Omega$ estimated for each model.
The RMSE are above each figure.

```{python}
fig, axes = plt.subplots(2, 2, figsize=(10, 10))
sns.heatmap(true_Omega, ax=axes[0, 0])
axes[0, 0].set_title("True Omega")
check_covariance_coef(zi, axes[1, 0], label="ZIPln on ZIPln data")
check_covariance_coef(fairpln, axes[0, 1], label="Pln on pln data.")
check_covariance_coef(pln, axes[1, 1], label="Pln on ZIpln data.")

fig.suptitle("Comparison of estimation of Omegas")
plt.show()
```
The RMSE for $\Omega$ is lower for ZIPln but the RMSE for $\Sigma$ is lower for Pln on Pln data. Interestingly, the MSE is equivalent for Pln on Pln data and Pln on ZIPln data ...
